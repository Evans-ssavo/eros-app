<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EROS ‚Äî Emergency Response Optimization System</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&family=Exo+2:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:#020810; --bg2:#060d18; --bg3:#091422; --bg4:#0c1a2e;
  --cyan:#00f5ff; --cyan2:#00aacc; --cyan-dim:rgba(0,245,255,0.08);
  --red:#ff1744; --red2:#ff6b6b; --orange:#ff6d00; --yellow:#ffd600;
  --green:#00e676; --purple:#7c4dff;
  --text:#a8c8d8; --text2:#5a7a8a; --bright:#e0f4ff;
  --border:rgba(0,245,255,0.12); --border2:rgba(0,245,255,0.25);
  --glow:0 0 20px rgba(0,245,255,0.2); --glow2:0 0 40px rgba(0,245,255,0.3);
  --red-glow:0 0 20px rgba(255,23,68,0.4);
  --font-hud:'Orbitron',monospace; --font-mono:'Share Tech Mono',monospace; --font-body:'Exo 2',sans-serif;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;overflow-x:hidden;cursor:crosshair;padding-bottom:26px}
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(0,245,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.03) 1px,transparent 1px);background-size:60px 60px;animation:gridShift 20s linear infinite}
@keyframes gridShift{from{background-position:0 0}to{background-position:60px 60px}}
.bg-scan{position:fixed;inset:0;pointer-events:none;z-index:1;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.04) 3px,rgba(0,0,0,0.04) 4px)}
.bg-vignette{position:fixed;inset:0;pointer-events:none;z-index:2;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,0.7) 100%)}

/* NAV */
nav{position:sticky;top:0;z-index:1000;height:64px;background:rgba(2,8,16,0.95);border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between;padding:0 2rem;backdrop-filter:blur(20px)}
nav::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);animation:scanLine 4s ease-in-out infinite}
@keyframes scanLine{0%,100%{opacity:0.3}50%{opacity:1}}
.nav-logo{font-family:var(--font-hud);font-size:1.3rem;font-weight:900;letter-spacing:6px;color:var(--cyan);text-shadow:0 0 30px rgba(0,245,255,0.6);position:relative}
.nav-logo::before{content:'EROS';position:absolute;inset:0;color:var(--red);clip-path:polygon(0 45%,100% 45%,100% 55%,0 55%);animation:glitch 8s infinite;opacity:0}
@keyframes glitch{0%,94%,100%{opacity:0;transform:none}95%{opacity:1;transform:translateX(3px)}97%{opacity:1;transform:translateX(-3px)}99%{opacity:0}}
.nav-logo span{color:var(--red);text-shadow:var(--red-glow)}
.nav-center{display:flex;gap:0.25rem}
.nav-tab{position:relative;padding:0.4rem 1.4rem;background:transparent;border:1px solid transparent;color:var(--text2);font-family:var(--font-hud);font-size:0.65rem;font-weight:500;letter-spacing:3px;cursor:pointer;transition:all 0.3s;text-transform:uppercase;clip-path:polygon(8px 0%,100% 0%,100% 100%,0% 100%,0% 8px)}
.nav-tab:hover{color:var(--cyan);border-color:var(--border2);background:var(--cyan-dim)}
.nav-tab.active{color:var(--cyan);border-color:var(--cyan);background:rgba(0,245,255,0.06);box-shadow:var(--glow),inset 0 0 20px rgba(0,245,255,0.05)}
.nav-tab.active::after{content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--cyan);box-shadow:var(--glow)}
.nav-right{display:flex;align-items:center;gap:1.5rem}
.sys-status{display:flex;align-items:center;gap:0.5rem;font-family:var(--font-mono);font-size:0.7rem;color:var(--green)}
.sys-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 12px var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.nav-time{font-family:var(--font-mono);font-size:0.8rem;color:var(--cyan);letter-spacing:2px;text-shadow:0 0 10px rgba(0,245,255,0.5)}

/* PAGES */
.page{display:none;position:relative;z-index:10;padding:1.5rem 2rem;min-height:calc(100vh - 64px)}
.page.active{display:block;animation:pageIn 0.4s ease}
@keyframes pageIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* HUD BOX */
.hud-box{position:relative;background:rgba(6,13,24,0.8);border:1px solid var(--border);backdrop-filter:blur(10px)}
.hud-box::before,.hud-box::after,.hud-box .cbr,.hud-box .ctl{content:'';position:absolute;width:12px;height:12px;border-color:var(--cyan);border-style:solid}
.hud-box::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.hud-box::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}
.hud-box .cbr{bottom:-1px;left:-1px;border-width:0 0 2px 2px}
.hud-box .ctl{top:-1px;right:-1px;border-width:2px 2px 0 0}
.hud-title{font-family:var(--font-hud);font-size:0.65rem;font-weight:600;letter-spacing:4px;color:var(--text2);text-transform:uppercase;padding:0.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ht-accent{color:var(--cyan);font-size:0.6rem}

/* ‚îÄ‚îÄ SOS ‚îÄ‚îÄ */
.sos-page{display:grid;grid-template-columns:1fr 360px;gap:1.5rem;align-items:start}
.sos-main{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2rem;min-height:calc(100vh - 148px)}
.sos-header{text-align:center}
.sos-header h2{font-family:var(--font-hud);font-size:0.7rem;letter-spacing:8px;color:var(--text2);margin-bottom:0.3rem}
.sos-header p{font-family:var(--font-mono);font-size:0.75rem;color:var(--text2)}
.sos-arena{position:relative;width:280px;height:280px;display:flex;align-items:center;justify-content:center}
.sos-orbit{position:absolute;border-radius:50%;border:1px solid rgba(0,245,255,0.15);animation:orbit 8s linear infinite}
.sos-orbit:nth-child(1){width:100%;height:100%;animation-duration:12s}
.sos-orbit:nth-child(2){width:80%;height:80%;animation-duration:8s;animation-direction:reverse}
.sos-orbit:nth-child(3){width:60%;height:60%;animation-duration:5s}
@keyframes orbit{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sos-orbit:nth-child(1)::after,.sos-orbit:nth-child(2)::after,.sos-orbit:nth-child(3)::after{content:'';position:absolute;width:6px;height:6px;border-radius:50%;background:var(--cyan);top:-3px;left:50%;box-shadow:0 0 10px var(--cyan)}
.sos-btn-outer{position:relative;z-index:5;width:160px;height:160px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 30% 30%,rgba(255,23,68,0.3),rgba(255,23,68,0.05));border:2px solid rgba(255,23,68,0.5);box-shadow:0 0 40px rgba(255,23,68,0.2),inset 0 0 40px rgba(255,23,68,0.05);cursor:pointer;transition:all 0.2s;animation:sosBreath 3s ease-in-out infinite}
@keyframes sosBreath{0%,100%{box-shadow:0 0 40px rgba(255,23,68,0.2),inset 0 0 40px rgba(255,23,68,0.05)}50%{box-shadow:0 0 80px rgba(255,23,68,0.5),inset 0 0 40px rgba(255,23,68,0.15)}}
.sos-btn-outer:hover{transform:scale(1.05);box-shadow:0 0 80px rgba(255,23,68,0.6),inset 0 0 40px rgba(255,23,68,0.2);border-color:var(--red)}
.sos-btn-outer:active{transform:scale(0.97)}
.sos-btn-outer.triggered{animation:sosFire 0.6s ease;border-color:var(--red)}
@keyframes sosFire{0%{transform:scale(1)}30%{transform:scale(1.2);box-shadow:0 0 150px rgba(255,23,68,1)}100%{transform:scale(1)}}
.sos-btn-inner{display:flex;flex-direction:column;align-items:center;gap:0.2rem;pointer-events:none}
.s-label{font-family:var(--font-hud);font-size:2.5rem;font-weight:900;color:var(--red);letter-spacing:4px;text-shadow:0 0 30px rgba(255,23,68,0.8);line-height:1}
.s-sub{font-family:var(--font-mono);font-size:0.55rem;color:rgba(255,100,100,0.7);letter-spacing:2px}
.sos-countdown{display:none;flex-direction:column;align-items:center;gap:0.5rem}
.sos-countdown.show{display:flex}
.cd-label{font-family:var(--font-hud);font-size:0.6rem;letter-spacing:4px;color:var(--text2)}
.cd-timer{font-family:var(--font-hud);font-size:3rem;font-weight:700;color:var(--red);text-shadow:var(--red-glow);line-height:1}
.cd-bar-track{width:200px;height:4px;background:rgba(255,23,68,0.2)}
.cd-bar-fill{height:100%;background:var(--red);transition:width 1s linear;box-shadow:var(--red-glow)}
.cd-msg{font-family:var(--font-mono);font-size:0.7rem;color:var(--red);text-align:center;margin-top:0.5rem;animation:blink 0.5s infinite}
.sos-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;width:100%;max-width:520px}
.sos-card{padding:0.8rem;text-align:center;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));background:rgba(0,245,255,0.04);border:1px solid var(--border);transition:border-color 0.3s}
.sos-card:hover{border-color:var(--cyan)}
.sc-label{font-family:var(--font-mono);font-size:0.6rem;color:var(--text2);letter-spacing:2px;margin-bottom:0.4rem}
.sc-val{font-family:var(--font-hud);font-size:0.95rem;font-weight:600;color:var(--cyan)}
.sos-sidebar{display:flex;flex-direction:column;gap:1rem;padding-top:0.5rem}
.alert-feed{display:flex;flex-direction:column;gap:0.5rem;max-height:400px;overflow-y:auto;padding:0.75rem}
.alert-feed::-webkit-scrollbar{width:3px}
.alert-feed::-webkit-scrollbar-thumb{background:var(--border2)}
.alert-item{padding:0.6rem 0.8rem;border-left:3px solid;background:rgba(0,0,0,0.3);font-family:var(--font-mono);font-size:0.7rem;animation:slideIn 0.3s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.alert-item.crit{border-color:var(--red);color:var(--red2)}
.alert-item.med{border-color:var(--orange);color:var(--orange)}
.alert-item.ok{border-color:var(--green);color:var(--green)}
.ai-time{font-size:0.6rem;opacity:0.6;margin-bottom:0.2rem}

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
.map-layout{display:grid;grid-template-columns:1fr 300px;gap:1.5rem;height:calc(100vh - 100px)}
.map-canvas{position:relative;overflow:hidden;background:#040e1a;border:1px solid var(--border2)}
.map-canvas::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 30% 40%,rgba(0,100,150,0.08) 0%,transparent 60%),radial-gradient(ellipse at 70% 60%,rgba(0,50,100,0.06) 0%,transparent 50%);pointer-events:none;z-index:1}
.map-streets{position:absolute;inset:0;z-index:2}
.map-streets svg{width:100%;height:100%}
.map-compass{position:absolute;top:1rem;left:1rem;z-index:20;font-family:var(--font-hud);font-size:0.55rem;color:rgba(0,245,255,0.4);letter-spacing:2px}
.map-scale{position:absolute;bottom:1rem;left:1rem;z-index:20;font-family:var(--font-mono);font-size:0.6rem;color:rgba(0,245,255,0.3);display:flex;align-items:center;gap:0.5rem}
.map-scale-bar{width:60px;height:2px;background:rgba(0,245,255,0.3)}
.map-coords{position:absolute;bottom:1rem;right:1rem;z-index:20;font-family:var(--font-mono);font-size:0.6rem;color:rgba(0,245,255,0.4);text-align:right}
.ipin{position:absolute;transform:translate(-50%,-100%);cursor:pointer;z-index:15;filter:drop-shadow(0 0 6px currentColor);transition:transform 0.2s}
.ipin:hover{transform:translate(-50%,-100%) scale(1.3);z-index:20}
.ipin svg{display:block}
.ipin .ipin-label{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);font-family:var(--font-mono);font-size:0.6rem;white-space:nowrap;padding:2px 6px;background:var(--bg2);border:1px solid currentColor;opacity:0;transition:opacity 0.2s;pointer-events:none}
.ipin:hover .ipin-label{opacity:1}
.ipin.crit{color:var(--red)}.ipin.med{color:var(--orange)}.ipin.low{color:var(--yellow)}
.pin-ripple-anim{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;border:1px solid currentColor;animation:pinRipple 2s infinite;pointer-events:none}
@keyframes pinRipple{0%{width:10px;height:10px;opacity:0.8}100%{width:40px;height:40px;opacity:0}}
.map-side{display:flex;flex-direction:column;gap:1rem;overflow-y:auto}
.map-side::-webkit-scrollbar{width:3px}
.map-side::-webkit-scrollbar-thumb{background:var(--border2)}
.inc-list{display:flex;flex-direction:column;gap:0.4rem;padding:0.75rem;max-height:280px;overflow-y:auto}
.inc-list::-webkit-scrollbar{width:3px}
.inc-list::-webkit-scrollbar-thumb{background:var(--border2)}
.inc-row{padding:0.6rem 0.8rem;border:1px solid var(--border);cursor:pointer;transition:all 0.2s;position:relative;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%)}
.inc-row:hover{border-color:var(--cyan);background:var(--cyan-dim)}
.ir-type{font-family:var(--font-hud);font-size:0.7rem;font-weight:600;margin-bottom:0.2rem}
.ir-meta{font-family:var(--font-mono);font-size:0.6rem;color:var(--text2)}
.ir-badge{position:absolute;top:0.4rem;right:0.5rem;font-family:var(--font-mono);font-size:0.55rem;padding:1px 5px;border:1px solid}
.ir-badge.crit{color:var(--red);border-color:var(--red);background:rgba(255,23,68,0.1)}
.ir-badge.med{color:var(--orange);border-color:var(--orange);background:rgba(255,109,0,0.1)}
.ir-badge.low{color:var(--yellow);border-color:var(--yellow);background:rgba(255,214,0,0.1)}
.tag-form{display:flex;flex-direction:column;gap:0.5rem;padding:0.75rem}
.tag-form select,.tag-form input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.75rem;font-family:var(--font-mono);font-size:0.75rem;outline:none;transition:border-color 0.2s;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%)}
.tag-form select:focus,.tag-form input:focus{border-color:var(--cyan)}
.tag-btn{padding:0.5rem;background:rgba(0,245,255,0.08);border:1px solid var(--cyan2);color:var(--cyan);font-family:var(--font-hud);font-size:0.65rem;letter-spacing:3px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,0 100%)}
.tag-btn:hover{background:rgba(0,245,255,0.15);box-shadow:var(--glow)}

/* ‚îÄ‚îÄ ADMIN LOGIN ‚îÄ‚îÄ */
#adminLogin{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 120px);gap:2rem}
.login-box{width:400px;padding:2.5rem;background:rgba(6,13,24,0.9);border:1px solid var(--border2);position:relative;clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px))}
.login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent)}
.login-title{font-family:var(--font-hud);font-size:1rem;font-weight:700;letter-spacing:6px;color:var(--cyan);text-align:center;margin-bottom:0.3rem;text-shadow:var(--glow)}
.login-sub{font-family:var(--font-mono);font-size:0.65rem;color:var(--text2);text-align:center;margin-bottom:2rem;letter-spacing:2px}
.login-field{margin-bottom:1rem}
.login-field label{display:block;font-family:var(--font-hud);font-size:0.6rem;letter-spacing:3px;color:var(--text2);margin-bottom:0.4rem}
.login-field input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--bright);padding:0.75rem 1rem;font-family:var(--font-mono);font-size:0.85rem;outline:none;transition:border-color 0.2s}
.login-field input:focus{border-color:var(--cyan);box-shadow:0 0 0 1px rgba(0,245,255,0.1)}
.login-btn{width:100%;padding:0.8rem;background:rgba(0,245,255,0.1);border:1px solid var(--cyan);color:var(--cyan);font-family:var(--font-hud);font-size:0.75rem;letter-spacing:4px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,0 100%)}
.login-btn:hover{background:rgba(0,245,255,0.2);box-shadow:var(--glow2)}
.login-err{font-family:var(--font-mono);font-size:0.7rem;color:var(--red);text-align:center;margin-top:0.75rem;display:none}
.login-err.show{display:block;animation:blink 0.5s 3}

/* ‚îÄ‚îÄ ADMIN DASH ‚îÄ‚îÄ */
#adminDash{display:none}
#adminDash.show{display:block}
.admin-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem}
.admin-topbar h1{font-family:var(--font-hud);font-size:1rem;font-weight:700;letter-spacing:5px;color:var(--bright)}
.logout-btn{padding:0.3rem 1rem;background:rgba(255,23,68,0.1);border:1px solid rgba(255,23,68,0.4);color:var(--red);font-family:var(--font-hud);font-size:0.6rem;letter-spacing:2px;cursor:pointer;transition:all 0.2s}
.logout-btn:hover{background:rgba(255,23,68,0.2)}
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-tile{padding:1.2rem 1rem;background:rgba(6,13,24,0.8);border:1px solid var(--border);position:relative;overflow:hidden;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));transition:border-color 0.3s}
.stat-tile:hover{border-color:var(--cyan)}
.stat-tile::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%}
.stat-tile.t-red::before{background:var(--red);box-shadow:0 0 10px var(--red)}
.stat-tile.t-orange::before{background:var(--orange)}
.stat-tile.t-green::before{background:var(--green)}
.stat-tile.t-cyan::before{background:var(--cyan)}
.st-label{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:2px;color:var(--text2);margin-bottom:0.5rem}
.st-val{font-family:var(--font-hud);font-size:2rem;font-weight:700;color:var(--bright);line-height:1}
.st-sub{font-family:var(--font-mono);font-size:0.6rem;color:var(--text2);margin-top:0.3rem}
.admin-mid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
.admin-bot{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.5rem}
.chart-wrap{padding:1rem;height:220px;position:relative}
.pbar-section{padding:1rem}
.pbar-row{margin-bottom:1rem}
.pbar-row:last-child{margin-bottom:0}
.pbar-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem}
.pbar-name{font-family:var(--font-mono);font-size:0.7rem;color:var(--text)}
.pbar-pct{font-family:var(--font-hud);font-size:0.7rem;font-weight:600}
.pbar-track{height:6px;background:rgba(255,255,255,0.05);position:relative;overflow:hidden}
.pbar-fill{height:100%;transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.pbar-shine{position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shine 2s infinite}
@keyframes shine{from{left:-100%}to{left:200%}}
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:1px solid var(--border2)}
th{padding:0.6rem 0.8rem;font-family:var(--font-hud);font-size:0.55rem;letter-spacing:3px;color:var(--text2);text-align:left;text-transform:uppercase}
td{padding:0.55rem 0.8rem;font-family:var(--font-mono);font-size:0.7rem;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(0,245,255,0.03)}
tr:last-child td{border-bottom:none}
.resolve-btn{padding:2px 8px;background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.3);color:var(--green);font-family:var(--font-mono);font-size:0.6rem;cursor:pointer;transition:all 0.2s}
.resolve-btn:hover{background:rgba(0,230,118,0.2)}
.reports-scroll{max-height:220px;overflow-y:auto}
.reports-scroll::-webkit-scrollbar{width:3px}
.reports-scroll::-webkit-scrollbar-thumb{background:var(--border2)}

/* ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ */
.report-wrap{max-width:700px;margin:0 auto}
.rp-head{margin-bottom:2rem}
.rp-head h1{font-family:var(--font-hud);font-size:1.3rem;font-weight:700;letter-spacing:5px;color:var(--bright);margin-bottom:0.5rem}
.rp-head p{font-size:0.85rem;color:var(--text2);line-height:1.7}
.anon-badge{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;margin-bottom:1.5rem;background:rgba(0,245,255,0.04);border:1px solid rgba(0,245,255,0.2);font-family:var(--font-mono);font-size:0.75rem;color:var(--cyan)}
.rform{display:flex;flex-direction:column;gap:1.2rem}
.fg{display:flex;flex-direction:column;gap:0.4rem}
.fg label{font-family:var(--font-hud);font-size:0.6rem;letter-spacing:3px;color:var(--text2);text-transform:uppercase}
.fg input,.fg textarea,.fg select{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:0.75rem 1rem;font-family:var(--font-body);font-size:0.9rem;outline:none;transition:border-color 0.2s;resize:vertical;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,0 100%)}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--cyan);box-shadow:0 0 0 1px rgba(0,245,255,0.08)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.rsub-btn{padding:0.9rem;background:rgba(0,245,255,0.08);border:1px solid var(--cyan);color:var(--cyan);font-family:var(--font-hud);font-size:0.8rem;letter-spacing:5px;cursor:pointer;text-transform:uppercase;transition:all 0.2s;clip-path:polygon(0 0,calc(100% - 12px) 0,100% 12px,100% 100%,0 100%)}
.rsub-btn:hover{background:rgba(0,245,255,0.15);box-shadow:var(--glow2)}
.rsub-btn:disabled{opacity:0.4;cursor:not-allowed}
.r-success{display:none;text-align:center;padding:3rem;border:1px solid var(--green);background:rgba(0,230,118,0.04);clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,0 100%)}
.r-success.show{display:block;animation:pageIn 0.4s ease}
.rs-icon{font-size:3rem;color:var(--green);margin-bottom:1rem}
.rs-title{font-family:var(--font-hud);font-size:1.2rem;letter-spacing:4px;color:var(--green)}
.rs-id{font-family:var(--font-mono);font-size:0.8rem;color:var(--text2);margin-top:0.5rem}

/* FOOTER */
.footer{position:fixed;bottom:0;left:0;right:0;height:26px;background:rgba(2,8,16,0.95);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 1.5rem;gap:2.5rem;z-index:1000;backdrop-filter:blur(10px)}
.footer::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);opacity:0.3}
.fi{font-family:var(--font-mono);font-size:0.6rem;color:var(--text2)}
.fi span{color:var(--cyan)}

/* TOAST */
.toast{position:fixed;bottom:40px;right:2rem;padding:0.75rem 1.5rem;z-index:2000;background:rgba(6,13,24,0.95);border:1px solid var(--green);color:var(--green);font-family:var(--font-mono);font-size:0.8rem;display:none;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,0 100%);backdrop-filter:blur(20px)}
.toast.err{border-color:var(--red);color:var(--red)}
.toast.show{display:block;animation:pageIn 0.3s ease}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-scan"></div>
<div class="bg-vignette"></div>

<nav>
  <div class="nav-logo">ER<span>OS</span></div>
  <div class="nav-center">
    <button class="nav-tab active" onclick="showPage('sos',this)">SOS</button>
    <button class="nav-tab" onclick="showPage('map',this)">Live Map</button>
    <button class="nav-tab" onclick="showPage('admin',this)">Admin</button>
    <button class="nav-tab" onclick="showPage('report',this)">Report</button>
  </div>
  <div class="nav-right">
    <div class="sys-status"><div class="sys-dot"></div><span>SYSTEM NOMINAL</span></div>
    <div class="nav-time" id="navClock">--:--:--</div>
  </div>
</nav>

<!-- SOS PAGE -->
<div id="page-sos" class="page active">
  <div class="sos-page">
    <div class="sos-main">
      <div class="sos-header">
        <h2>Emergency Activation</h2>
        <p>TAP THE SOS BUTTON TO BROADCAST YOUR LOCATION</p>
      </div>
      <div class="sos-arena">
        <div class="sos-orbit"></div>
        <div class="sos-orbit"></div>
        <div class="sos-orbit"></div>
        <div class="sos-btn-outer" id="sosBtn" onclick="triggerSOS()">
          <div class="sos-btn-inner">
            <div class="s-label">SOS</div>
            <div class="s-sub">EMERGENCY</div>
          </div>
        </div>
      </div>
      <div class="sos-countdown" id="sosCountdown">
        <div class="cd-label">RESPONSE COUNTDOWN</div>
        <div class="cd-timer" id="cdTimer">04:00</div>
        <div class="cd-bar-track"><div class="cd-bar-fill" id="cdBar" style="width:100%"></div></div>
        <div class="cd-msg">‚ö° UNIT DISPATCHED ‚Äî HOLD YOUR POSITION</div>
      </div>
      <div class="sos-cards">
        <div class="sos-card"><div class="sc-label">GPS SIGNAL</div><div class="sc-val" id="gpsStatus">ACQUIRING</div></div>
        <div class="sos-card"><div class="sc-label">NEAREST UNIT</div><div class="sc-val">UNIT-07</div></div>
        <div class="sos-card"><div class="sc-label">ETA</div><div class="sc-val">~4 MIN</div></div>
      </div>
    </div>
    <div class="sos-sidebar">
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Alert Feed <span class="ht-accent" id="alertCount">0 ACTIVE</span></div>
        <div class="alert-feed" id="alertFeed">
          <div class="alert-item ok"><div class="ai-time">System Ready</div>No active alerts</div>
        </div>
      </div>
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Emergency Contacts</div>
        <div style="padding:0.75rem;display:flex;flex-direction:column;gap:0.5rem">
          <div class="sos-card" style="text-align:left;display:flex;justify-content:space-between;align-items:center">
            <div><div class="sc-label">Police</div><div style="font-family:var(--font-hud);font-size:1rem;color:var(--cyan)">999</div></div>
            <div style="font-size:1.5rem">üöî</div>
          </div>
          <div class="sos-card" style="text-align:left;display:flex;justify-content:space-between;align-items:center">
            <div><div class="sc-label">Ambulance</div><div style="font-family:var(--font-hud);font-size:1rem;color:var(--red)">112</div></div>
            <div style="font-size:1.5rem">üöë</div>
          </div>
          <div class="sos-card" style="text-align:left;display:flex;justify-content:space-between;align-items:center">
            <div><div class="sc-label">Fire</div><div style="font-family:var(--font-hud);font-size:1rem;color:var(--orange)">998</div></div>
            <div style="font-size:1.5rem">üöí</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MAP PAGE -->
<div id="page-map" class="page">
  <div class="map-layout">
    <div class="map-canvas hud-box" id="mapCanvas">
      <div class="cbr"></div><div class="ctl"></div>
      <div class="map-streets">
        <svg viewBox="0 0 900 650" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="900" height="650" fill="#030d18"/>
          <ellipse cx="750" cy="500" rx="120" ry="90" fill="rgba(0,50,100,0.3)" stroke="rgba(0,100,200,0.2)" stroke-width="1"/>
          <text x="750" y="504" fill="rgba(0,150,255,0.3)" font-family="Share Tech Mono" font-size="9" text-anchor="middle">RIVER DELTA</text>
          <line x1="0" y1="200" x2="900" y2="200" stroke="rgba(0,245,255,0.12)" stroke-width="14"/>
          <line x1="0" y1="420" x2="900" y2="420" stroke="rgba(0,245,255,0.12)" stroke-width="14"/>
          <line x1="220" y1="0" x2="220" y2="650" stroke="rgba(0,245,255,0.12)" stroke-width="14"/>
          <line x1="580" y1="0" x2="580" y2="650" stroke="rgba(0,245,255,0.12)" stroke-width="14"/>
          <text x="450" y="193" fill="rgba(0,245,255,0.25)" font-family="Share Tech Mono" font-size="8" text-anchor="middle">CENTRAL AVE</text>
          <text x="450" y="413" fill="rgba(0,245,255,0.25)" font-family="Share Tech Mono" font-size="8" text-anchor="middle">SOUTH HIGHWAY</text>
          <line x1="0" y1="100" x2="900" y2="100" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="0" y1="310" x2="900" y2="310" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="0" y1="530" x2="900" y2="530" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="100" y1="0" x2="100" y2="650" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="400" y1="0" x2="400" y2="650" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="720" y1="0" x2="720" y2="650" stroke="rgba(0,245,255,0.06)" stroke-width="6"/>
          <line x1="0" y1="420" x2="580" y2="0" stroke="rgba(0,245,255,0.07)" stroke-width="8"/>
          <line x1="220" y1="650" x2="900" y2="200" stroke="rgba(0,245,255,0.07)" stroke-width="8"/>
          <rect x="240" y="220" width="140" height="80" fill="rgba(0,40,80,0.3)" stroke="rgba(0,245,255,0.05)" stroke-width="1"/>
          <rect x="240" y="320" width="140" height="80" fill="rgba(0,40,80,0.2)" stroke="rgba(0,245,255,0.05)" stroke-width="1"/>
          <rect x="600" y="220" width="100" height="80" fill="rgba(0,40,80,0.25)" stroke="rgba(0,245,255,0.05)" stroke-width="1"/>
          <rect x="120" y="120" width="80" height="60" fill="rgba(0,40,80,0.2)" stroke="rgba(0,245,255,0.04)" stroke-width="1"/>
          <rect x="420" y="440" width="140" height="70" fill="rgba(0,40,80,0.2)" stroke="rgba(0,245,255,0.04)" stroke-width="1"/>
          <text x="310" y="265" fill="rgba(0,245,255,0.2)" font-family="Share Tech Mono" font-size="7" text-anchor="middle">DOWNTOWN</text>
          <text x="650" y="265" fill="rgba(0,245,255,0.2)" font-family="Share Tech Mono" font-size="7" text-anchor="middle">WESTSIDE</text>
          <text x="490" y="480" fill="rgba(0,245,255,0.2)" font-family="Share Tech Mono" font-size="7" text-anchor="middle">SOUTH DIST</text>
        </svg>
      </div>
      <div class="map-compass">N ‚Üë</div>
      <div class="map-scale"><div class="map-scale-bar"></div>500m</div>
      <div class="map-coords" id="mapCoords">LAT: -1.2864¬∞ | LNG: 36.8172¬∞</div>
    </div>
    <div class="map-side">
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Active Incidents <span class="ht-accent" id="mapIncCount">LOADING</span></div>
        <div class="inc-list" id="incidentList"><div style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text2);padding:0.5rem">Loading...</div></div>
      </div>
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Tag Incident</div>
        <div class="tag-form">
          <select id="incType"><option>Fire</option><option>Medical Emergency</option><option>Accident</option><option>Crime</option><option>Flood</option><option>Other</option></select>
          <select id="incPriority"><option value="critical">‚ö† Critical</option><option value="medium">‚óè Medium</option><option value="low">‚óã Low</option></select>
          <input type="text" id="incLocation" placeholder="Location description"/>
          <button class="tag-btn" onclick="addIncident()">+ TAG INCIDENT</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page">
  <div id="adminLogin">
    <div class="login-box">
      <div class="login-title">ADMIN ACCESS</div>
      <div class="login-sub">AUTHORIZED PERSONNEL ONLY</div>
      <div class="login-field"><label>Username</label><input type="text" id="loginUser" placeholder="Enter username" autocomplete="off"/></div>
      <div class="login-field"><label>Password</label><input type="password" id="loginPass" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <button class="login-btn" onclick="doLogin()">AUTHENTICATE ‚Üí</button>
      <div class="login-err" id="loginErr">‚ö† ACCESS DENIED ‚Äî INVALID CREDENTIALS</div>
    </div>
  </div>
  <div id="adminDash">
    <div class="admin-topbar">
      <h1>COMMAND DASHBOARD</h1>
      <button class="logout-btn" onclick="doLogout()">‚èª LOGOUT</button>
    </div>
    <div class="stat-row">
      <div class="stat-tile t-red"><div class="st-label">Active Incidents</div><div class="st-val" id="statActive">‚Äî</div><div class="st-sub">Live count</div></div>
      <div class="stat-tile t-orange"><div class="st-label">Critical</div><div class="st-val" id="statCrit">‚Äî</div><div class="st-sub">Immediate response</div></div>
      <div class="stat-tile t-green"><div class="st-label">SOS Today</div><div class="st-val" id="statSOS">‚Äî</div><div class="st-sub">Last 24 hours</div></div>
      <div class="stat-tile t-cyan"><div class="st-label">Reports Today</div><div class="st-val" id="statReports">‚Äî</div><div class="st-sub">Anonymous</div></div>
    </div>
    <div class="admin-mid">
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Incident Trend (7 Days)</div>
        <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
      </div>
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Priority Distribution</div>
        <div class="chart-wrap"><canvas id="donutChart"></canvas></div>
      </div>
    </div>
    <div class="admin-bot">
      <div class="hud-box" style="grid-column:span 2"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Recent Incidents <span class="ht-accent" id="tableCount"></span></div>
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Location</th><th>Priority</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="adminTable"><tr><td colspan="6" style="text-align:center;color:var(--text2)">Loading...</td></tr></tbody>
        </table>
      </div>
      <div class="hud-box"><div class="cbr"></div><div class="ctl"></div>
        <div class="hud-title">Priority Routing</div>
        <div class="pbar-section">
          <div class="pbar-row">
            <div class="pbar-head"><span class="pbar-name">Critical</span><span class="pbar-pct" style="color:var(--red)" id="pctCrit">0%</span></div>
            <div class="pbar-track"><div class="pbar-fill" id="barCrit" style="width:0%;background:var(--red)"><div class="pbar-shine"></div></div></div>
          </div>
          <div class="pbar-row">
            <div class="pbar-head"><span class="pbar-name">Medium</span><span class="pbar-pct" style="color:var(--orange)" id="pctMed">0%</span></div>
            <div class="pbar-track"><div class="pbar-fill" id="barMed" style="width:0%;background:var(--orange)"><div class="pbar-shine"></div></div></div>
          </div>
          <div class="pbar-row">
            <div class="pbar-head"><span class="pbar-name">Low</span><span class="pbar-pct" style="color:var(--yellow)" id="pctLow">0%</span></div>
            <div class="pbar-track"><div class="pbar-fill" id="barLow" style="width:0%;background:var(--yellow)"><div class="pbar-shine"></div></div></div>
          </div>
        </div>
        <div class="hud-title" style="margin-top:0.5rem">Anonymous Reports</div>
        <div class="reports-scroll">
          <table>
            <thead><tr><th>Type</th><th>Severity</th><th>Status</th></tr></thead>
            <tbody id="reportsTable"><tr><td colspan="3" style="text-align:center;color:var(--text2)">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REPORT PAGE -->
<div id="page-report" class="page">
  <div class="report-wrap">
    <div class="rp-head">
      <h1>Anonymous Report</h1>
      <p>Submit reports of harassment, safety concerns, or incidents. Your identity is never stored or linked to this submission.</p>
    </div>
    <div class="anon-badge"><span style="font-size:1.2rem">üîí</span>End-to-end anonymous. No IP, device, or identity data is logged.</div>
    <div id="rForm" class="rform">
      <div class="frow">
        <div class="fg"><label>Incident Type</label><select id="rType"><option>Harassment</option><option>Verbal Abuse</option><option>Physical Threat</option><option>Suspicious Activity</option><option>Vandalism</option><option>Other</option></select></div>
        <div class="fg"><label>Severity</label><select id="rSeverity"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></div>
      </div>
      <div class="fg"><label>Location / Area</label><input type="text" id="rLoc" placeholder="e.g. Main Street near bus stop 12"/></div>
      <div class="fg"><label>Date & Time</label><input type="datetime-local" id="rTime"/></div>
      <div class="fg"><label>Description</label><textarea rows="5" id="rDesc" placeholder="Describe what happened..."></textarea></div>
      <button class="rsub-btn" id="rSubBtn" onclick="submitReport()">SUBMIT ANONYMOUSLY ‚Üí</button>
    </div>
    <div id="rSuccess" class="r-success">
      <div class="rs-icon">‚úì</div>
      <div class="rs-title">REPORT SUBMITTED</div>
      <div style="color:var(--text2);font-size:0.85rem;margin-top:0.5rem">Your anonymous report has been received and will be reviewed.</div>
      <div class="rs-id" id="rRefId"></div>
      <br>
      <button class="rsub-btn" onclick="resetReport()" style="margin-top:1rem">SUBMIT ANOTHER ‚Üí</button>
    </div>
  </div>
</div>

<div class="footer">
  <div class="fi">EROS <span>v2.0</span></div>
  <div class="fi">Incidents: <span id="footerInc">‚Äî</span></div>
  <div class="fi">DB: <span id="dbStat">connecting</span></div>
  <div class="fi">GPS: <span id="footerGPS">‚Äî</span></div>
  <div class="fi" style="margin-left:auto" id="footerTime"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'eros2024';
let adminLoggedIn = sessionStorage.getItem('erosAdmin') === 'true';
let trendChartInst = null, donutChartInst = null;
let userLat = null, userLng = null, cdInterval = null;

function toast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast show${type==='err'?' err':''}`;
  setTimeout(()=>t.classList.remove('show'), 3500);
}

async function api(path, opts={}) {
  try {
    const r = await fetch(path, {headers:{'Content-Type':'application/json'}, ...opts});
    const d = await r.json();
    if (!r.ok) throw new Error(d.error||'Request failed');
    return d;
  } catch(e) { toast(e.message,'err'); throw e; }
}

function fmt(d) { return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }

function updateClock() {
  const now = new Date();
  const t = now.toTimeString().slice(0,8);
  document.getElementById('navClock').textContent = t;
  document.getElementById('footerTime').innerHTML = `<span>${now.toLocaleDateString()}</span> ${t}`;
}
setInterval(updateClock,1000); updateClock();

function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  if (id==='map') loadMap();
  if (id==='admin') initAdmin();
}

function initGPS() {
  if (!navigator.geolocation) { document.getElementById('gpsStatus').textContent='UNAVAIL'; return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    userLat = pos.coords.latitude; userLng = pos.coords.longitude;
    document.getElementById('gpsStatus').textContent = userLat.toFixed(3)+'¬∞';
    document.getElementById('mapCoords').textContent = `LAT: ${userLat.toFixed(4)}¬∞ | LNG: ${userLng.toFixed(4)}¬∞`;
    document.getElementById('footerGPS').textContent = 'LOCKED';
    document.getElementById('footerGPS').style.color = 'var(--green)';
  }, ()=>{ document.getElementById('gpsStatus').textContent = 'DENIED'; });
}

let sosBusy = false;
async function triggerSOS() {
  if (sosBusy) return;
  sosBusy = true;
  const btn = document.getElementById('sosBtn');
  btn.classList.add('triggered');
  try {
    await api('/api/sos', {method:'POST', body:JSON.stringify({latitude:userLat,longitude:userLng,address:userLat?`${userLat.toFixed(4)}, ${userLng.toFixed(4)}`:'Unknown'})});
    startCountdown(240);
    addAlert('SOS transmitted ‚Äî unit dispatched','crit');
    toast('üö® SOS sent. Help is on the way.');
    loadFooter();
  } catch(e) { sosBusy=false; }
  setTimeout(()=>btn.classList.remove('triggered'),600);
  setTimeout(()=>{sosBusy=false;},12000);
}

function startCountdown(seconds) {
  const cd = document.getElementById('sosCountdown');
  const timer = document.getElementById('cdTimer');
  const bar = document.getElementById('cdBar');
  cd.classList.add('show');
  let rem = seconds;
  if (cdInterval) clearInterval(cdInterval);
  cdInterval = setInterval(()=>{
    rem--;
    timer.textContent = String(Math.floor(rem/60)).padStart(2,'0')+':'+String(rem%60).padStart(2,'0');
    bar.style.width = (rem/seconds*100)+'%';
    if (rem<=0) { clearInterval(cdInterval); cd.classList.remove('show'); }
  },1000);
}

function addAlert(msg, type='ok') {
  const feed = document.getElementById('alertFeed');
  const item = document.createElement('div');
  item.className = `alert-item ${type}`;
  const now = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  item.innerHTML = `<div class="ai-time">${now}</div>${msg}`;
  feed.prepend(item);
  const empty = feed.querySelector('.ok:last-child');
  if (empty && empty.textContent.includes('No active')) empty.remove();
  document.getElementById('alertCount').textContent = feed.children.length+' ACTIVE';
}

async function loadMap() {
  try {
    const {data} = await api('/api/incidents');
    const canvas = document.getElementById('mapCanvas');
    canvas.querySelectorAll('.ipin').forEach(p=>p.remove());
    const active = data.filter(i=>i.status==='active');
    document.getElementById('mapIncCount').textContent = active.length+' ACTIVE';
    if (!active.length) {
      document.getElementById('incidentList').innerHTML = '<div style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text2);padding:0.5rem">No active incidents</div>';
      return;
    }
    active.forEach(inc=>{
      const cls = inc.priority==='critical'?'crit':inc.priority==='medium'?'med':'low';
      const color = inc.priority==='critical'?'#ff1744':inc.priority==='medium'?'#ff6d00':'#ffd600';
      const pin = document.createElement('div');
      pin.className = `ipin ${cls}`;
      pin.style.left = (inc.map_x||50)+'%'; pin.style.top = (inc.map_y||50)+'%';
      pin.innerHTML = `<div class="ipin-label">${inc.type} ¬∑ ${inc.location}</div><div class="pin-ripple-anim" style="color:${color}"></div><svg width="20" height="28" viewBox="0 0 20 28"><path d="M10 0C4.5 0 0 4.5 0 10c0 7.5 10 18 10 18s10-10.5 10-18C20 4.5 15.5 0 10 0z" fill="${color}" opacity="0.9"/><circle cx="10" cy="10" r="4" fill="rgba(0,0,0,0.5)"/></svg>`;
      canvas.appendChild(pin);
    });
    document.getElementById('incidentList').innerHTML = active.slice(0,8).map(inc=>{
      const cls = inc.priority==='critical'?'crit':inc.priority==='medium'?'med':'low';
      const col = inc.priority==='critical'?'var(--red)':inc.priority==='medium'?'var(--orange)':'var(--yellow)';
      return `<div class="inc-row"><div class="ir-type" style="color:${col}">${inc.type}</div><div class="ir-meta">${inc.location} ¬∑ ${fmt(inc.reported_at)}</div><span class="ir-badge ${cls}">${inc.priority.toUpperCase()}</span></div>`;
    }).join('');
  } catch(e) {}
}

async function addIncident() {
  const type = document.getElementById('incType').value;
  const priority = document.getElementById('incPriority').value;
  const location = document.getElementById('incLocation').value.trim();
  if (!location) { toast('Enter a location','err'); return; }
  try {
    await api('/api/incidents',{method:'POST',body:JSON.stringify({type,priority,location})});
    document.getElementById('incLocation').value='';
    toast('Incident tagged'); loadMap(); loadFooter();
    addAlert(`New ${priority} incident: ${type}`, priority==='critical'?'crit':priority==='medium'?'med':'ok');
  } catch(e) {}
}

function doLogin() {
  const u = document.getElementById('loginUser').value;
  const p = document.getElementById('loginPass').value;
  if (u===ADMIN_USER && p===ADMIN_PASS) {
    adminLoggedIn=true; sessionStorage.setItem('erosAdmin','true');
    document.getElementById('adminLogin').style.display='none';
    document.getElementById('adminDash').classList.add('show');
    loadAdmin();
  } else {
    const err = document.getElementById('loginErr');
    err.classList.add('show'); setTimeout(()=>err.classList.remove('show'),3000);
  }
}

function doLogout() {
  adminLoggedIn=false; sessionStorage.removeItem('erosAdmin');
  document.getElementById('adminDash').classList.remove('show');
  document.getElementById('adminLogin').style.display='flex';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
}

function initAdmin() {
  if (adminLoggedIn) {
    document.getElementById('adminLogin').style.display='none';
    document.getElementById('adminDash').classList.add('show');
    loadAdmin();
  } else {
    document.getElementById('adminLogin').style.display='flex';
    document.getElementById('adminDash').classList.remove('show');
  }
}

async function loadAdmin() {
  try {
    const {data:s} = await api('/api/incidents/stats/summary');
    document.getElementById('statActive').textContent=s.active;
    document.getElementById('statCrit').textContent=s.critical;
    document.getElementById('statSOS').textContent=s.sos_today;
    document.getElementById('statReports').textContent=s.reports_today;
    const total=s.active||1;
    const pC=Math.round(s.critical/total*100), pM=Math.round(s.medium/total*100), pL=Math.round(s.low/total*100);
    setTimeout(()=>{
      document.getElementById('barCrit').style.width=pC+'%'; document.getElementById('pctCrit').textContent=pC+'%';
      document.getElementById('barMed').style.width=pM+'%'; document.getElementById('pctMed').textContent=pM+'%';
      document.getElementById('barLow').style.width=pL+'%'; document.getElementById('pctLow').textContent=pL+'%';
    },200);
    buildDonut(s.critical,s.medium,s.low);
    const {data:inc} = await api('/api/incidents');
    document.getElementById('tableCount').textContent=inc.length+' TOTAL';
    document.getElementById('adminTable').innerHTML = inc.length ? inc.slice(0,10).map(i=>{
      const cls=i.priority==='critical'?'crit':i.priority==='medium'?'med':'low';
      const col=i.status==='resolved'?'var(--green)':i.status==='active'?'var(--orange)':'var(--yellow)';
      return `<tr><td>${fmt(i.reported_at)}</td><td>${i.type}</td><td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i.location}</td><td><span class="ir-badge ${cls}" style="position:static">${i.priority.slice(0,4).toUpperCase()}</span></td><td style="color:${col}">${i.status}</td><td>${i.status!=='resolved'?`<button class="resolve-btn" onclick="resolveInc('${i.id}')">‚úì Resolve</button>`:'-'}</td></tr>`;
    }).join('') : '<tr><td colspan="6" style="text-align:center;color:var(--text2)">No incidents yet</td></tr>';
    buildTrend(inc);
    const {data:rpts} = await api('/api/reports');
    document.getElementById('reportsTable').innerHTML = rpts.length ? rpts.slice(0,8).map(r=>{
      const sc=r.severity?.toLowerCase();
      const col=sc==='critical'?'var(--red)':sc==='high'?'var(--orange)':sc==='medium'?'var(--yellow)':'var(--green)';
      return `<tr><td>${r.incident_type}</td><td style="color:${col}">${r.severity}</td><td style="color:${r.status==='resolved'?'var(--green)':'var(--yellow)'}">${r.status}</td></tr>`;
    }).join('') : '<tr><td colspan="3" style="text-align:center;color:var(--text2)">No reports</td></tr>';
  } catch(e) {}
}

async function resolveInc(id) {
  try { await api(`/api/incidents/${id}/resolve`,{method:'PATCH'}); toast('Incident resolved'); loadAdmin(); loadFooter(); } catch(e) {}
}

function buildTrend(incidents) {
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const counts = days.map(()=>Math.floor(Math.random()*8)+1);
  if (incidents.length) counts[counts.length-1]=incidents.filter(i=>i.status==='active').length;
  if (trendChartInst) trendChartInst.destroy();
  trendChartInst = new Chart(document.getElementById('trendChart').getContext('2d'),{
    type:'line',
    data:{labels:days,datasets:[
      {label:'Incidents',data:counts,borderColor:'#00f5ff',backgroundColor:'rgba(0,245,255,0.08)',borderWidth:2,pointBackgroundColor:'#00f5ff',pointRadius:4,tension:0.4,fill:true},
      {label:'Resolved',data:counts.map(c=>Math.floor(c*0.6)),borderColor:'#00e676',backgroundColor:'rgba(0,230,118,0.04)',borderWidth:1.5,pointBackgroundColor:'#00e676',pointRadius:3,tension:0.4,fill:true,borderDash:[4,4]}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#5a7a8a',font:{family:'Share Tech Mono',size:10},boxWidth:12}}},scales:{x:{grid:{color:'rgba(0,245,255,0.05)'},ticks:{color:'#5a7a8a',font:{family:'Share Tech Mono',size:10}}},y:{grid:{color:'rgba(0,245,255,0.05)'},ticks:{color:'#5a7a8a',font:{family:'Share Tech Mono',size:10}}}}}
  });
}

function buildDonut(crit,med,low) {
  if (donutChartInst) donutChartInst.destroy();
  donutChartInst = new Chart(document.getElementById('donutChart').getContext('2d'),{
    type:'doughnut',
    data:{labels:['Critical','Medium','Low'],datasets:[{data:[crit||1,med||1,low||1],backgroundColor:['rgba(255,23,68,0.8)','rgba(255,109,0,0.8)','rgba(255,214,0,0.8)'],borderColor:['#ff1744','#ff6d00','#ffd600'],borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'right',labels:{color:'#a8c8d8',font:{family:'Share Tech Mono',size:10},boxWidth:12}}}}
  });
}

async function submitReport() {
  const type=document.getElementById('rType').value, severity=document.getElementById('rSeverity').value;
  const loc=document.getElementById('rLoc').value.trim(), time=document.getElementById('rTime').value;
  const desc=document.getElementById('rDesc').value.trim();
  if (!loc||!desc) { toast('Fill in location and description','err'); return; }
  const btn=document.getElementById('rSubBtn');
  btn.disabled=true; btn.textContent='TRANSMITTING...';
  try {
    const {data}=await api('/api/reports',{method:'POST',body:JSON.stringify({incident_type:type,severity,location:loc,incident_time:time||null,description:desc})});
    document.getElementById('rForm').style.display='none';
    document.getElementById('rSuccess').classList.add('show');
    document.getElementById('rRefId').textContent='Reference: '+data.reference_id;
  } catch(e) { btn.disabled=false; btn.textContent='SUBMIT ANONYMOUSLY ‚Üí'; }
}

function resetReport() {
  document.getElementById('rForm').style.display='';
  document.getElementById('rSuccess').classList.remove('show');
  const btn=document.getElementById('rSubBtn');
  btn.disabled=false; btn.textContent='SUBMIT ANONYMOUSLY ‚Üí';
  ['rLoc','rDesc'].forEach(id=>document.getElementById(id).value='');
}

async function loadFooter() {
  try {
    const {data}=await api('/api/incidents/stats/summary');
    document.getElementById('footerInc').textContent=data.active;
    const dbEl=document.getElementById('dbStat');
    dbEl.textContent='ONLINE'; dbEl.style.color='var(--green)';
  } catch(e) {
    const dbEl=document.getElementById('dbStat');
    dbEl.textContent='ERROR'; dbEl.style.color='var(--red)';
  }
}

initGPS(); loadMap(); loadFooter();
setInterval(loadFooter,30000);
</script>
</body>
</html>
